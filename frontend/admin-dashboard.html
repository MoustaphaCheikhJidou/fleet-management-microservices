<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Fleet Management | Admin Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/app.css" />
  </head>
  <body class="ui-body" data-page="admin">
    <div class="admin-layout">
      <aside class="admin-sidebar">
        <div class="admin-sidebar__brand">
          <span class="logo-pill">FleetOS</span>
          <strong>Portail Administrateur</strong>
          <p class="sidebar-note">Application Distribuée de Gestion d’un Parc Automobile.</p>
        </div>
        <nav class="admin-sidebar__menu" aria-label="Navigation administrateur">
          <ul class="admin-sidebar__nav">
            <li><a href="#resume">Vue d’ensemble</a></li>
            <li><a href="#usersBoard">Utilisateurs</a></li>
            <li><a href="#adminBoard">Administrateurs</a></li>
            <li><a href="#servicesBoard">État des services</a></li>
            <li><a href="#rolesView">Synthèse rôles</a></li>
            <li><a href="dashboard.html">Vue opérateur</a></li>
            <li><a href="signup.html">Inscription Carrier/Driver</a></li>
            <li><a href="README.md" target="_blank" rel="noreferrer">Guide Fleet</a></li>
          </ul>
        </nav>
        <button id="logoutBtn" class="ghost-button ghost-button--light admin-sidebar__logout">Déconnexion</button>
      </aside>

      <main class="admin-main">
        <header class="admin-topbar" id="resume">
          <div>
            <p class="eyebrow">Application Distribuée de Gestion d’un Parc Automobile</p>
            <h1 id="userEmail">Administrateur connecté</h1>
            <p>Rôles portés par votre JWT :</p>
            <ul id="roleBadges" class="role-badges"></ul>
          </div>
          <div class="admin-topbar__session">
            <p>Token signé</p>
            <strong id="tokenPreview">—</strong>
            <p class="field-note">Signé par Gateway (8080) + IAM (8090)</p>
          </div>
        </header>

        <section class="admin-metrics" data-visible-for="ROLE_ADMIN" hidden>
          <article class="admin-metric">
            <p>Comptes totaux</p>
            <h3 id="adminUsersCount">0</h3>
            <p class="stat-sub">Tous rôles confondus</p>
          </article>
          <article class="admin-metric">
            <p>Comptes actifs</p>
            <h3 id="adminEnabledCount">0</h3>
            <p class="stat-sub">Utilisateurs habilités</p>
          </article>
          <article class="admin-metric">
            <p>SuperAdmin</p>
            <h3>SUPERADMIN_*</h3>
            <p class="stat-sub">Seeder vérifie l’email admin1@gmail.com</p>
          </article>
        </section>

        <section class="admin-card" id="usersBoard" data-visible-for="ROLE_ADMIN" hidden>
          <header>
            <div>
              <p class="eyebrow">Utilisateurs</p>
              <h2>Liste complète des comptes IAM</h2>
              <p class="field-note">GET /api/v1/admin/users via Gateway</p>
            </div>
            <div class="admin-card__actions">
              <button id="refreshUsersBtn" class="ghost-button">Actualiser</button>
            </div>
          </header>
          <p id="adminUsersStatus" class="status-text"></p>
          <div class="table-wrapper" role="region" aria-live="polite">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Utilisateur</th>
                  <th>Email</th>
                  <th>Rôles</th>
                  <th>Statut</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="adminUsersBody"></tbody>
            </table>
          </div>
        </section>

        <section class="admin-card admin-card--stacked" id="adminBoard" data-visible-for="ROLE_ADMIN" hidden>
          <header>
            <div>
              <p class="eyebrow">Administrateurs</p>
              <h2>Créer et auditer les comptes ROLE_ADMIN</h2>
              <p class="field-note">Seed + portail garantissent le respect des rôles</p>
            </div>
            <div class="admin-card__actions">
              <button id="refreshAdminsBtn" class="ghost-button">Actualiser les admins</button>
            </div>
          </header>
          <div class="admin-panels admin-panels--stacked">
            <article class="admin-card admin-card--sub">
              <h3>Créer un administrateur</h3>
              <p class="field-note">Le seeder garantit au moins un SuperAdmin, ce formulaire ajoute des comptes additionnels.</p>
              <form id="createAdminForm" class="form-grid form-grid--stacked">
                <div class="form-field">
                  <label class="form-label" for="adminUsername">Nom d’utilisateur</label>
                  <input class="form-control" id="adminUsername" name="username" required placeholder="ex: fleet.supervisor" />
                </div>
                <div class="form-field">
                  <label class="form-label" for="adminEmail">Email</label>
                  <input class="form-control" id="adminEmail" name="email" type="email" required placeholder="admin@entreprise.com" />
                </div>
                <div class="form-field">
                  <label class="form-label" for="adminPassword">Mot de passe</label>
                  <input class="form-control" id="adminPassword" name="password" type="password" required minlength="8" />
                </div>
                <button class="primary-button" type="submit">Créer l’administrateur</button>
              </form>
              <p id="adminFormStatus" class="status-text" role="status" aria-live="polite"></p>
            </article>

            <article class="admin-card admin-card--sub">
              <header>
                <div>
                  <h3>Administrateurs existants</h3>
                  <p class="field-note">GET /api/v1/admin/users/admins</p>
                </div>
                <p id="adminOnlyStatus" class="status-text"></p>
              </header>
              <div class="admin-admins__header">
                <p>Total administrateurs : <strong id="adminOnlyCount">0</strong></p>
              </div>
              <div class="table-wrapper" role="region" aria-live="polite">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Utilisateur</th>
                      <th>Email</th>
                      <th>Statut</th>
                    </tr>
                  </thead>
                  <tbody id="adminOnlyBody"></tbody>
                </table>
              </div>
            </article>
          </div>
        </section>

        <section class="admin-card services-board" id="servicesBoard" data-visible-for="ROLE_ADMIN" hidden>
          <header>
            <div>
              <p class="eyebrow">Services critiques</p>
              <h2>Suivre la santé Gateway, IAM, Vehicles et Issues</h2>
              <p class="field-note">Les cartes ci-dessous ouvrent directement les endpoints Actuator.</p>
            </div>
            <button id="healthBtn" class="primary-button">Tester via Gateway</button>
          </header>
          <div class="services-board__grid">
            <article class="service-card">
              <div class="service-card__head">
                <h3>Gateway-service</h3>
                <span>Port 8080</span>
              </div>
              <p>Filtre JWT + routage vers tous les microservices. Remonte les propriétés depuis Config Server.</p>
              <div class="service-card__links">
                <a class="ghost-button" href="http://localhost:8080/actuator/health" target="_blank" rel="noreferrer">Health Gateway</a>
              </div>
            </article>
            <article class="service-card">
              <div class="service-card__head">
                <h3>IAM-service</h3>
                <span>Port 8090</span>
              </div>
              <p>Gestion des utilisateurs, rôles et SuperAdmin. Restreint /api/v1/admin/** à ROLE_ADMIN.</p>
              <div class="service-card__links">
                <a class="ghost-button" href="http://localhost:8090/actuator/health" target="_blank" rel="noreferrer">Health IAM</a>
              </div>
            </article>
            <article class="service-card">
              <div class="service-card__head">
                <h3>Vehicles-service</h3>
                <span>Port 8095</span>
              </div>
              <p>Catalogue véhicules + suivi GPS. Accessible via Gateway `/api/v1/vehicles/**`.</p>
              <div class="service-card__links">
                <a class="ghost-button" href="http://localhost:8095/actuator/health" target="_blank" rel="noreferrer">Health Vehicles</a>
              </div>
            </article>
            <article class="service-card">
              <div class="service-card__head">
                <h3>Issues-service</h3>
                <span>Port 8096</span>
              </div>
              <p>Gestion des incidents terrain partagés aux dispatchers. Utilise RabbitMQ pour les alertes.</p>
              <div class="service-card__links">
                <a class="ghost-button" href="http://localhost:8096/actuator/health" target="_blank" rel="noreferrer">Health Issues</a>
              </div>
            </article>
          </div>
          <div id="healthResult" class="admin-health__result" aria-live="polite">
            Cliquez sur « Tester via Gateway » pour interroger http://localhost:8080/actuator/health.
          </div>
        </section>

        <section class="admin-card role-synthesis" id="rolesView" data-visible-for="ROLE_ADMIN" hidden>
          <header>
            <div>
              <p class="eyebrow">Vue multi-rôles</p>
              <h2>Synthèse fonctionnelle des profils utilisateurs</h2>
            </div>
          </header>
          <div class="role-synthesis__grid">
            <article class="role-card">
              <h3>ROLE_ADMIN</h3>
              <ul>
                <li>Accès portail admin + endpoints `/api/v1/admin/**`.</li>
                <li>Création/suspension des comptes et monitoring des services.</li>
                <li>Peut provisionner d’autres admins (formulaire ci-dessus).</li>
              </ul>
            </article>
            <article class="role-card">
              <h3>ROLE_CARRIER</h3>
              <ul>
                <li>Vue dashboard.html pour planifier flotte et opérations.</li>
                <li>Lecture/écriture sur Vehicles & Shipments via Gateway.</li>
                <li>Accès au support incidents pour déclarer une anomalie.</li>
              </ul>
            </article>
            <article class="role-card">
              <h3>ROLE_DRIVER</h3>
              <ul>
                <li>Accès rapide au suivi individuel et à la feuille de route.</li>
                <li>Remontée d’événements Issues-service depuis le terrain.</li>
                <li>Connecté via login.html puis redirigé vers dashboard.html.</li>
              </ul>
            </article>
          </div>
        </section>
      </main>
    </div>

    <div id="adminToast" class="admin-toast" role="status" aria-live="polite" hidden></div>

    <script type="module" src="js/dashboard.js"></script>
  </body>
</html>
